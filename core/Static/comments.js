(()=>{(function(){let o=null;function r(){let i=document.getElementById("comments-app");if(!i||typeof Vue>"u"||!Vue.createApp)return;let s=window.Anon||{},c=s.config||{},m=(s.pageInfo||{}).id||0;if(!m)return;let p=c.apiPrefix||"",d=!!s.isLoggedIn,l=s.userInfo||{},g=i.innerHTML;i.innerHTML="",o&&o.unmount(),o=Vue.createApp({data(){return{postId:m,apiPrefix:p,comments:[],isLoggedIn:d,currentUser:l,message:"",messageType:"info",loading:!1,replyingTo:null,captchaEnabled:!1,captchaImage:"",captchaLoading:!1,form:{name:"",email:"",url:"",content:"",parent_id:null,captcha:""}}},computed:{topLevelComments(){return this.comments||[]},totalCommentCount(){let e=this.comments||[],n=0;for(let t=0;t<e.length;t++)n+=1,n+=e[t].children&&e[t].children.length?e[t].children.length:0;return n}},mounted(){this.loadComments(),this.checkCaptchaEnabled()},methods:{setReplyTo(e){this.replyingTo={id:e.id,name:e.name||"?"},this.form.parent_id=e.id},cancelReply(){this.replyingTo=null,this.form.parent_id=null},formatDate(e){if(e==null||e==="")return"";let n;if(typeof e=="number"?n=e<1e12?e*1e3:e:n=new Date(e).getTime(),!n||isNaN(n))return"";let t=new Date(n),a=t.getFullYear(),h=String(t.getMonth()+1).padStart(2,"0"),f=String(t.getDate()).padStart(2,"0"),u=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");return`${a}-${h}-${f} ${u}:${y}`},loadComments(){let e=this;fetch(`/anon/cms/comments?post_id=${encodeURIComponent(this.postId)}`,{method:"GET",headers:{Accept:"application/json"},credentials:"same-origin"}).then(n=>n.json()).then(n=>{let t=n&&n.data?n.data:{};e.comments=t.comments||[]}).catch(()=>{e.comments=[]})},checkCaptchaEnabled(){let e=this;if(e.isLoggedIn){e.captchaEnabled=!1;return}window.Anon&&window.Anon.config&&window.Anon.config.captcha?(e.captchaEnabled=!0,e.loadCaptcha()):e.captchaEnabled=!1},loadCaptcha(){let e=this;e.captchaLoading||!e.captchaEnabled||(e.captchaLoading=!0,fetch(`${this.apiPrefix}/auth/captcha`,{method:"GET",headers:{Accept:"application/json"},credentials:"same-origin"}).then(n=>n.json()).then(n=>{e.captchaLoading=!1,n&&n.code===200&&n.data&&n.data.image&&(e.captchaImage=n.data.image,e.form.captcha="")}).catch(()=>{e.captchaLoading=!1}))},refreshCaptcha(){this.loadCaptcha()},submitComment(){let e=this;if(this.message="",!this.form.content.trim()){this.messageType="error",this.message=this.isLoggedIn?"\u8BF7\u586B\u5199\u8BC4\u8BBA\u5185\u5BB9":"\u8BF7\u586B\u5199\u540D\u79F0\u3001\u90AE\u7BB1\u548C\u8BC4\u8BBA\u5185\u5BB9";return}if(!this.isLoggedIn&&(!this.form.name.trim()||!this.form.email.trim())){this.messageType="error",this.message="\u8BF7\u586B\u5199\u540D\u79F0\u3001\u90AE\u7BB1\u548C\u8BC4\u8BBA\u5185\u5BB9";return}if(this.captchaEnabled&&!this.form.captcha.trim()){this.messageType="error",this.message="\u8BF7\u8F93\u5165\u9A8C\u8BC1\u7801";return}this.loading=!0;let n={post_id:String(this.postId),content:this.form.content.trim(),url:this.form.url.trim()};this.form.parent_id&&(n.parent_id=String(this.form.parent_id)),this.isLoggedIn||(n.name=this.form.name.trim(),n.email=this.form.email.trim()),this.captchaEnabled&&(n.captcha=this.form.captcha.trim());let t=new URLSearchParams(n);fetch("/anon/cms/comments",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:t.toString()}).then(a=>a.json()).then(a=>{e.loading=!1,a&&a.code===200?(e.messageType="info",e.message=a.message||"\u8BC4\u8BBA\u5DF2\u63D0\u4EA4\uFF0C\u5F85\u5BA1\u6838\u901A\u8FC7\u540E\u4F1A\u663E\u793A\u3002",e.form={name:"",email:"",url:"",content:"",parent_id:null,captcha:""},e.replyingTo=null,e.captchaEnabled&&e.loadCaptcha(),e.loadComments()):(e.messageType="error",e.message=a&&a.message?a.message:"\u63D0\u4EA4\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5\u3002",e.captchaEnabled&&a&&a.message&&a.message.indexOf("\u9A8C\u8BC1\u7801")!==-1&&e.loadCaptcha())}).catch(()=>{e.loading=!1,e.messageType="error",e.message="\u63D0\u4EA4\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u540E\u91CD\u8BD5\u3002"})}},template:g}),o&&o.mount("#comments-app")}r(),window.__anonInitComments=r,typeof document.addEventListener<"u"&&document.addEventListener("pjax:complete",function(){let i=window.__anonInitComments;typeof i=="function"&&i()})})();})();
