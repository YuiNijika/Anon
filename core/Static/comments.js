(()=>{(function(){function s(){let i=document.getElementById("comments-app");if(!i||typeof Vue>"u"||!Vue.createApp)return;let r=i.getAttribute("data-post-id")||"0",m=parseInt(r,10);if(!m)return;let a=i.getAttribute("data-comment-logged-in")==="1",d=i.innerHTML;i.innerHTML="",Vue.createApp({data(){return{postId:m,comments:[],isLoggedIn:a,message:"",messageType:"info",loading:!1,replyingTo:null,form:{name:"",email:"",url:"",content:"",parent_id:null}}},computed:{topLevelComments(){return this.comments||[]},totalCommentCount(){let e=this.comments||[],t=0;for(let n=0;n<e.length;n++)t+=1,t+=e[n].children&&e[n].children.length?e[n].children.length:0;return t}},mounted(){this.loadComments()},methods:{setReplyTo(e){this.replyingTo={id:e.id,name:e.name||"?"},this.form.parent_id=e.id},cancelReply(){this.replyingTo=null,this.form.parent_id=null},formatDate(e){if(e==null||e==="")return"";let t;if(typeof e=="number"?t=e<1e12?e*1e3:e:t=new Date(e).getTime(),!t||isNaN(t))return"";let n=new Date(t),o=n.getFullYear(),p=String(n.getMonth()+1).padStart(2,"0"),l=String(n.getDate()).padStart(2,"0"),g=String(n.getHours()).padStart(2,"0"),c=String(n.getMinutes()).padStart(2,"0");return`${o}-${p}-${l} ${g}:${c}`},loadComments(){let e=this;fetch(`/anon/cms/comments?post_id=${encodeURIComponent(this.postId)}`,{method:"GET",headers:{Accept:"application/json"},credentials:"same-origin"}).then(t=>t.json()).then(t=>{let n=t&&t.data?t.data:{};e.comments=n.comments||[]}).catch(()=>{e.comments=[]})},submitComment(){let e=this;if(this.message="",!this.form.content.trim()){this.messageType="error",this.message=this.isLoggedIn?"\u8BF7\u586B\u5199\u8BC4\u8BBA\u5185\u5BB9":"\u8BF7\u586B\u5199\u540D\u79F0\u3001\u90AE\u7BB1\u548C\u8BC4\u8BBA\u5185\u5BB9";return}if(!this.isLoggedIn&&(!this.form.name.trim()||!this.form.email.trim())){this.messageType="error",this.message="\u8BF7\u586B\u5199\u540D\u79F0\u3001\u90AE\u7BB1\u548C\u8BC4\u8BBA\u5185\u5BB9";return}this.loading=!0;let t={post_id:String(this.postId),content:this.form.content.trim(),url:this.form.url.trim()};this.form.parent_id&&(t.parent_id=String(this.form.parent_id)),this.isLoggedIn||(t.name=this.form.name.trim(),t.email=this.form.email.trim());let n=new URLSearchParams(t);fetch("/anon/cms/comments",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:n.toString()}).then(o=>o.json()).then(o=>{e.loading=!1,o&&o.code===200?(e.messageType="info",e.message=o.message||"\u8BC4\u8BBA\u5DF2\u63D0\u4EA4\uFF0C\u5F85\u5BA1\u6838\u901A\u8FC7\u540E\u4F1A\u663E\u793A\u3002",e.form={name:"",email:"",url:"",content:"",parent_id:null},e.replyingTo=null,e.loadComments()):(e.messageType="error",e.message=o&&o.message?o.message:"\u63D0\u4EA4\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5\u3002")}).catch(()=>{e.loading=!1,e.messageType="error",e.message="\u63D0\u4EA4\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u540E\u91CD\u8BD5\u3002"})}},template:d}).mount("#comments-app")}s(),window.__anonInitComments=s,typeof document.addEventListener<"u"&&document.addEventListener("pjax:complete",function(){let i=window.__anonInitComments;typeof i=="function"&&setTimeout(function(){i()},100)})})();})();
