import{_ as s,o as i,c as a,ah as e}from"./chunks/framework.Zhm0w2YF.js";const k=JSON.parse('{"title":"评论功能","description":"","frontmatter":{},"headers":[],"relativePath":"guide/cms/comments.md","filePath":"guide/cms/comments.md","lastUpdated":null}'),d={name:"guide/cms/comments.md"};function n(o,t,h,l,r,p){return i(),a("div",null,[...t[0]||(t[0]=[e(`<h1 id="评论功能" tabindex="-1">评论功能 <a class="header-anchor" href="#评论功能" aria-label="Permalink to &quot;评论功能&quot;">​</a></h1><p><strong>本节说明</strong>：CMS 评论的数据结构、主题接口、主题内调用方式及管理后台。<strong>适用</strong>：仅 CMS 模式。</p><p>评论支持文章下的二级嵌套回复（类似 B 站「回复 @用户名」），登录用户评论默认通过审核，游客评论进入待审核。</p><h2 id="评论表与状态" tabindex="-1">评论表与状态 <a class="header-anchor" href="#评论表与状态" aria-label="Permalink to &quot;评论表与状态&quot;">​</a></h2><ul><li>表：<code>{prefix}comments</code>，字段含 <code>id</code>、<code>post_id</code>、<code>parent_id</code>、<code>uid</code>、<code>type</code>（<code>user</code>/<code>guest</code>）、<code>name</code>、<code>email</code>、<code>url</code>、<code>ip</code>、<code>user_agent</code>、<code>content</code>、<code>status</code>、<code>created_at</code>。</li><li>状态：<code>pending</code>（待审核）、<code>approved</code>（已通过）、<code>spam</code>（垃圾）、<code>trash</code>（已删除）。</li><li>二级嵌套：<code>parent_id</code> 指向顶级评论；回复时接口会返回 <code>reply_to_name</code> 用于前端展示「回复 @xxx」。</li></ul><h2 id="主题评论接口-前端-主题调用" tabindex="-1">主题评论接口（前端/主题调用） <a class="header-anchor" href="#主题评论接口-前端-主题调用" aria-label="Permalink to &quot;主题评论接口（前端/主题调用）&quot;">​</a></h2><p>统一入口：<code>/anon/cms/comments</code>，无需登录。</p><h3 id="get-获取评论列表" tabindex="-1">GET：获取评论列表 <a class="header-anchor" href="#get-获取评论列表" aria-label="Permalink to &quot;GET：获取评论列表&quot;">​</a></h3><ul><li><strong>请求</strong>：<code>GET /anon/cms/comments?post_id={文章ID}</code></li><li><strong>响应</strong>：<code>data.comments</code> 为<strong>树形结构</strong>的已通过评论；已登录时附带 <code>data.currentUser</code>（<code>displayName</code>、<code>name</code>、<code>avatar</code>，不含 email）。</li></ul><p><strong>树形结构说明</strong>：<code>data.comments</code> 为根评论数组，每条根评论带有 <code>children</code> 数组（其回复列表），便于前端直接渲染层级。</p><p>单条评论结构（供主题/Vue 使用）：</p><table tabindex="0"><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>评论 ID</td></tr><tr><td>post_id</td><td>文章 ID</td></tr><tr><td>parent_id</td><td>父评论 ID，顶级为 null</td></tr><tr><td>children</td><td>子回复数组（仅根评论有此字段）</td></tr><tr><td>reply_to_name</td><td>回复时被回复人名称（展示 @ 用）</td></tr><tr><td>type</td><td>user / guest</td></tr><tr><td>name</td><td>显示名称</td></tr><tr><td>avatar</td><td>头像 URL（用户表或 Gravatar）</td></tr><tr><td>url</td><td>评论者网址（可选）</td></tr><tr><td>content</td><td>内容</td></tr><tr><td>created_at</td><td>Unix 时间戳（秒）</td></tr></tbody></table><p>主题接口<strong>不返回</strong> email，避免泄露。</p><h3 id="post-提交评论" tabindex="-1">POST：提交评论 <a class="header-anchor" href="#post-提交评论" aria-label="Permalink to &quot;POST：提交评论&quot;">​</a></h3><ul><li><strong>请求</strong>：<code>POST /anon/cms/comments</code>，<code>Content-Type: application/x-www-form-urlencoded</code>，建议带 <code>X-Requested-With: XMLHttpRequest</code> 以收到 JSON 响应。</li><li><strong>Body</strong>：<code>post_id</code>、<code>content</code> 必填；未登录时需 <code>name</code>、<code>email</code>，可选 <code>url</code>；回复时传 <code>parent_id</code>（父评论 ID，仅支持回复顶级评论）。</li><li>登录用户只需传 <code>post_id</code>、<code>content</code>（及可选 <code>url</code>、<code>parent_id</code>），name/email 由后端从当前用户补齐；登录用户评论默认 <code>approved</code>，游客默认 <code>pending</code>。</li><li><strong>响应文案</strong>：登录用户提交成功返回「评论发表成功」并立即展示；游客返回「评论已提交，待审核通过后会显示。」。</li></ul><h2 id="主题内-this-调用" tabindex="-1">主题内 $this 调用 <a class="header-anchor" href="#主题内-this-调用" aria-label="Permalink to &quot;主题内 $this 调用&quot;">​</a></h2><p>在主题模板/组件中可直接使用以下方法（由 <code>Anon_Cms_Theme_View</code> 提供）：</p><table tabindex="0"><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>$this-&gt;getCommentsByPostId($postId)</code></td><td>获取某文章已通过评论列表（与 GET 接口一致，供服务端渲染时用）</td></tr><tr><td><code>$this-&gt;getPostComments($postId)</code></td><td>同上，别名</td></tr><tr><td><code>$this-&gt;getCommentDisplayName()</code></td><td>当前登录用户显示名，未登录或取不到时为空</td></tr><tr><td><code>$this-&gt;isLoggedIn()</code></td><td>是否已登录</td></tr></tbody></table><p>默认主题评论区组件（<code>app/components/comments.php</code>）用法示例：</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$post </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $post </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$post </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;post&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;comment_status&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;open&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;open&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$postId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) $post</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$commentLoggedIn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isLoggedIn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$commentDisplayName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCommentDisplayName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;登录用户&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>评论列表通常由前端通过 GET <code>/anon/cms/comments?post_id=...</code> 拉取并渲染；若需服务端直接输出列表，可 <code>$this-&gt;getCommentsByPostId($postId)</code> 得到相同<strong>树形</strong>结构。</p><h2 id="评论区脚本与-pjax" tabindex="-1">评论区脚本与 PJAX <a class="header-anchor" href="#评论区脚本与-pjax" aria-label="Permalink to &quot;评论区脚本与 PJAX&quot;">​</a></h2><ul><li>评论 Vue 脚本仅在**文章页（post）或页面（page）**输出，其他页面不注入，避免多余请求。</li><li>使用 PJAX 进入内页时，主题需在内容替换后重新初始化评论区：调用全局重载方法 <code>window.__anonInitComments()</code>（若存在）。默认主题在 <code>initPage()</code> 中已调用，进入文章页后评论列表会正常加载。</li></ul><h2 id="管理后台评论管理" tabindex="-1">管理后台评论管理 <a class="header-anchor" href="#管理后台评论管理" aria-label="Permalink to &quot;管理后台评论管理&quot;">​</a></h2><ul><li><strong>菜单位置</strong>：管理后台侧栏「管理」→「评论」。</li><li><strong>端点</strong>：见 <a href="/Anon/api/endpoints.html#评论管理接口">API 端点 - 评论管理</a>。</li><li><strong>能力</strong>：列表（分页）、<strong>高级筛选</strong>（状态、类型 登录/游客、根评论/仅回复、内容关键词、日期范围）、状态改为通过/待审核/垃圾/回收站、编辑评论内容、永久删除；列表展示 IP、<strong>解析后的 UA</strong>（浏览器·系统）、回复关系（回复 @xxx）、子评论行高亮。</li></ul><h2 id="头像与-gravatar" tabindex="-1">头像与 Gravatar <a class="header-anchor" href="#头像与-gravatar" aria-label="Permalink to &quot;头像与 Gravatar&quot;">​</a></h2><ul><li>登录用户：头像来自用户表 <code>avatar</code>，为空时由用户表逻辑按 email 生成 Gravatar（配置 <code>app.avatar</code>，默认 cravatar.cn）。</li><li>游客：无 <code>avatar</code> 时按评论中的 email 调用用户库的 <code>getAvatarByEmail</code> 生成 Gravatar，与用户表策略一致。</li></ul>`,27)])])}const g=s(d,[["render",n]]);export{k as __pageData,g as default};
