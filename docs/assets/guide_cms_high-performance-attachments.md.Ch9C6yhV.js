import{_ as s,o as i,c as e,ah as n}from"./chunks/framework.Zhm0w2YF.js";const k=JSON.parse('{"title":"高性能附件系统","description":"","frontmatter":{},"headers":[],"relativePath":"guide/cms/high-performance-attachments.md","filePath":"guide/cms/high-performance-attachments.md","lastUpdated":null}'),l={name:"guide/cms/high-performance-attachments.md"};function t(p,a,h,o,r,d){return i(),e("div",null,[...a[0]||(a[0]=[n(`<h1 id="高性能附件系统" tabindex="-1">高性能附件系统 <a class="header-anchor" href="#高性能附件系统" aria-label="Permalink to &quot;高性能附件系统&quot;">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>实现 Discuz 风格的强缓存机制，首次 PHP 鉴权后浏览器永久缓存，后续访问 0 PHP 消耗。</p><h2 id="核心机制" tabindex="-1">核心机制 <a class="header-anchor" href="#核心机制" aria-label="Permalink to &quot;核心机制&quot;">​</a></h2><h3 id="缓存流程" tabindex="-1">缓存流程 <a class="header-anchor" href="#缓存流程" aria-label="Permalink to &quot;缓存流程&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>首次访问: PHP鉴权 → 输出文件 → 写强缓存(10年)</span></span>
<span class="line"><span>后续访问: 浏览器/CDN直接读缓存</span></span></code></pre></div><h3 id="路由格式" tabindex="-1">路由格式 <a class="header-anchor" href="#路由格式" aria-label="Permalink to &quot;路由格式&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET /anon/attachment/{filetype}/{filename}/{imgtype?}</span></span></code></pre></div><p><strong>参数说明：</strong></p><ul><li><code>filetype</code>: 文件类型（image/video/audio/document/other）</li><li><code>filename</code>: 文件基础名（不含扩展名）</li><li><code>imgtype</code>: 可选，图片转换格式（webp/jpg/jpeg/png）</li></ul><h3 id="图片处理功能" tabindex="-1">图片处理功能 <a class="header-anchor" href="#图片处理功能" aria-label="Permalink to &quot;图片处理功能&quot;">​</a></h3><p><strong>1. 格式转换</strong></p><ul><li>支持 WebP/JPG/PNG/GIF/AVIF</li><li>保持图片质量</li></ul><p><strong>2. 尺寸缩放</strong></p><ul><li>等比缩放至指定尺寸内</li><li>自动保持原图比例</li><li>透明度完美支持</li></ul><p><strong>处理逻辑:</strong></p><ul><li>无尺寸参数: 原图格式转换</li><li>有尺寸参数: 等比缩放到指定尺寸内</li><li>超出原图尺寸: 按原图输出</li><li>小于原图尺寸: 等比缩小</li></ul><h3 id="示例url" tabindex="-1">示例URL <a class="header-anchor" href="#示例url" aria-label="Permalink to &quot;示例URL&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># 原始图片访问</span></span>
<span class="line"><span>/anon/attachment/image/a1b2c3d4e5f67890-1760000000</span></span>
<span class="line"><span></span></span>
<span class="line"><span># WebP格式转换</span></span>
<span class="line"><span>/anon/attachment/image/a1b2c3d4e5f67890-1760000000/webp</span></span>
<span class="line"><span></span></span>
<span class="line"><span># JPEG格式转换</span></span>
<span class="line"><span>/anon/attachment/image/a1b2c3d4e5f67890-1760000000/jpg</span></span></code></pre></div><h2 id="性能优势" tabindex="-1">性能优势 <a class="header-anchor" href="#性能优势" aria-label="Permalink to &quot;性能优势&quot;">​</a></h2><ul><li><strong>CPU降低</strong>: 80-90%</li><li><strong>内存减少</strong>: 70-80%</li><li><strong>响应时间</strong>: 几十毫秒 → 接近0</li><li><strong>并发提升</strong>: 10倍+</li></ul><h2 id="nginx配置" tabindex="-1">Nginx配置 <a class="header-anchor" href="#nginx配置" aria-label="Permalink to &quot;Nginx配置&quot;">​</a></h2><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 强缓存配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ~*</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ^/anon/attachment/ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    expires </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Cache-Control </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;public, immutable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    etag </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="安全特性" tabindex="-1">安全特性 <a class="header-anchor" href="#安全特性" aria-label="Permalink to &quot;安全特性&quot;">​</a></h2><ul><li>文件名安全过滤</li><li>MIME类型验证</li><li>路径遍历防护</li><li>数据库记录验证</li></ul><h2 id="主题静态资源" tabindex="-1">主题静态资源 <a class="header-anchor" href="#主题静态资源" aria-label="Permalink to &quot;主题静态资源&quot;">​</a></h2><p>自动注册以下路由:</p><ul><li><code>/theme/{theme}/assets/{file}</code></li><li><code>/theme/{theme}/css/{file}</code></li><li><code>/theme/{theme}/js/{file}</code></li></ul><p>手动注册:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_Http_StaticResource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">registerRoute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;/theme/custom/{file}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $filePath,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $mimeType,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    315360000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h2 id="注意事项" tabindex="-1">注意事项 <a class="header-anchor" href="#注意事项" aria-label="Permalink to &quot;注意事项&quot;">​</a></h2><ol><li>更新文件需改变URL或清缓存</li><li>合理规划存储目录</li><li>定期备份文件和数据库</li><li>监控访问日志</li></ol><p>这个高性能附件系统能够显著提升网站性能，特别适合高流量的CMS应用场景。</p>`,33)])])}const g=s(l,[["render",t]]);export{k as __pageData,g as default};
