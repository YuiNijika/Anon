import{_ as s,o as a,c as l,ah as n}from"./chunks/framework.Zhm0w2YF.js";const c=JSON.parse('{"title":"性能优化","description":"","frontmatter":{},"headers":[],"relativePath":"guide/api/performance-optimization.md","filePath":"guide/api/performance-optimization.md","lastUpdated":1770070015000}'),h={name:"guide/api/performance-optimization.md"};function e(t,i,k,p,r,d){return a(),l("div",null,[...i[0]||(i[0]=[n(`<h1 id="性能优化" tabindex="-1">性能优化 <a class="header-anchor" href="#性能优化" aria-label="Permalink to &quot;性能优化&quot;">​</a></h1><p>一句话：框架核心性能优化，提升响应速度和降低资源消耗。</p><hr><h2 id="数据库连接池化" tabindex="-1">数据库连接池化 <a class="header-anchor" href="#数据库连接池化" aria-label="Permalink to &quot;数据库连接池化&quot;">​</a></h2><h3 id="单例模式" tabindex="-1">单例模式 <a class="header-anchor" href="#单例模式" aria-label="Permalink to &quot;单例模式&quot;">​</a></h3><p><code>Anon_Database</code> 已改为单例模式，确保同一请求生命周期内复用数据库连接，减少连接创建开销。</p><h4 id="使用方式" tabindex="-1">使用方式 <a class="header-anchor" href="#使用方式" aria-label="Permalink to &quot;使用方式&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 推荐使用单例模式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$db </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_Database</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取查询构建器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;users&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p>实现原理包括私有构造函数防止外部实例化，<code>getInstance()</code> 方法确保全局唯一实例，防止克隆和反序列化，同一请求内多次调用返回同一实例。</p><h4 id="性能提升" tabindex="-1">性能提升 <a class="header-anchor" href="#性能提升" aria-label="Permalink to &quot;性能提升&quot;">​</a></h4><ul><li>减少数据库连接创建开销</li><li>降低内存占用</li><li>提高并发处理能力</li></ul><hr><h2 id="session-优化" tabindex="-1">Session 优化 <a class="header-anchor" href="#session-优化" aria-label="Permalink to &quot;Session 优化&quot;">​</a></h2><h3 id="csrf-token-无状态设计" tabindex="-1">CSRF Token 无状态设计 <a class="header-anchor" href="#csrf-token-无状态设计" aria-label="Permalink to &quot;CSRF Token 无状态设计&quot;">​</a></h3><p>采用基于 HMAC 的无状态 CSRF Token，无需存储在 Session 中，减少 Session 锁竞争。</p><h4 id="配置方式" tabindex="-1">配置方式 <a class="header-anchor" href="#配置方式" aria-label="Permalink to &quot;配置方式&quot;">​</a></h4><p>在 <code>useApp.php</code> 中配置：</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;app&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;security&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &#39;csrf&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &#39;enabled&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &#39;stateless&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 启用无状态 Token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span></code></pre></div><h4 id="工作原理" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理" aria-label="Permalink to &quot;工作原理&quot;">​</a></h4><p>无状态 Token 包含：</p><ul><li>时间戳：用于验证 Token 有效期</li><li>随机数：防止重放攻击</li><li>Session ID：关联用户会话</li><li>HMAC 签名：验证 Token 完整性</li></ul><h4 id="优势" tabindex="-1">优势 <a class="header-anchor" href="#优势" aria-label="Permalink to &quot;优势&quot;">​</a></h4><ul><li>无需存储在 Session 中，减少锁竞争</li><li>支持分布式部署</li><li>提高并发性能</li><li>Token 有效期 2 小时</li></ul><h4 id="兼容性" tabindex="-1">兼容性 <a class="header-anchor" href="#兼容性" aria-label="Permalink to &quot;兼容性&quot;">​</a></h4><p>框架同时支持：</p><ul><li>无状态 Token（默认，推荐）</li><li>传统 Session 存储（可通过配置切换）</li></ul><hr><h2 id="钩子系统轻量化" tabindex="-1">钩子系统轻量化 <a class="header-anchor" href="#钩子系统轻量化" aria-label="Permalink to &quot;钩子系统轻量化&quot;">​</a></h2><h3 id="回调缓存机制" tabindex="-1">回调缓存机制 <a class="header-anchor" href="#回调缓存机制" aria-label="Permalink to &quot;回调缓存机制&quot;">​</a></h3><p>钩子系统增加了回调缓存机制，避免重复解析回调函数，提升执行效率。</p><h4 id="优化内容" tabindex="-1">优化内容 <a class="header-anchor" href="#优化内容" aria-label="Permalink to &quot;优化内容&quot;">​</a></h4><ol><li><p><strong>回调函数缓存</strong></p><ul><li>缓存已解析的回调函数信息</li><li>避免重复反射和解析</li></ul></li><li><p><strong>执行结果缓存</strong></p><ul><li>过滤器钩子结果缓存</li><li>减少重复计算</li></ul></li><li><p><strong>闭包警告</strong></p><ul><li>使用闭包时记录警告日志</li><li>建议使用命名函数或类方法</li></ul></li></ol><h4 id="使用建议" tabindex="-1">使用建议 <a class="header-anchor" href="#使用建议" aria-label="Permalink to &quot;使用建议&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 推荐：使用命名函数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($data) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_System_Hook</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my_filter&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my_callback&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 推荐：使用类方法</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($data) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_System_Hook</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my_filter&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MyClass</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;callback&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 不推荐：使用闭包（影响性能）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_System_Hook</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my_filter&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($data) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h4 id="性能提升-1" tabindex="-1">性能提升 <a class="header-anchor" href="#性能提升-1" aria-label="Permalink to &quot;性能提升&quot;">​</a></h4><ul><li>减少回调函数解析开销</li><li>降低内存占用</li><li>提高钩子执行速度</li></ul><hr><h2 id="配置缓存" tabindex="-1">配置缓存 <a class="header-anchor" href="#配置缓存" aria-label="Permalink to &quot;配置缓存&quot;">​</a></h2><h3 id="配置值缓存" tabindex="-1">配置值缓存 <a class="header-anchor" href="#配置值缓存" aria-label="Permalink to &quot;配置值缓存&quot;">​</a></h3><p><code>Anon_System_Env</code> 内部缓存已加载的配置，首次解析后存入内存，后续调用直接读取缓存。</p><h4 id="工作原理-1" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理-1" aria-label="Permalink to &quot;工作原理&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 首次调用：解析配置并缓存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$value1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_System_Env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;app.token.enabled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 后续调用：直接从缓存读取</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$value2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_System_Env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;app.token.enabled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="清除缓存" tabindex="-1">清除缓存 <a class="header-anchor" href="#清除缓存" aria-label="Permalink to &quot;清除缓存&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 清除所有配置缓存</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_System_Env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><h4 id="性能提升-2" tabindex="-1">性能提升 <a class="header-anchor" href="#性能提升-2" aria-label="Permalink to &quot;性能提升&quot;">​</a></h4><ul><li>减少配置解析开销</li><li>降低 CPU 使用率</li><li>提高配置读取速度</li></ul><hr><h2 id="token-验证缓存" tabindex="-1">Token 验证缓存 <a class="header-anchor" href="#token-验证缓存" aria-label="Permalink to &quot;Token 验证缓存&quot;">​</a></h2><h3 id="验证结果缓存" tabindex="-1">验证结果缓存 <a class="header-anchor" href="#验证结果缓存" aria-label="Permalink to &quot;验证结果缓存&quot;">​</a></h3><p>对已验证的 Token 暂存于内存缓存，避免重复计算验证逻辑。</p><h4 id="工作原理-2" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理-2" aria-label="Permalink to &quot;工作原理&quot;">​</a></h4><ol><li>Token 验证成功后，将结果存入缓存</li><li>缓存有效期设置为 Token 剩余有效期的 80%</li><li>后续相同 Token 的验证直接从缓存读取</li></ol><h4 id="缓存策略" tabindex="-1">缓存策略 <a class="header-anchor" href="#缓存策略" aria-label="Permalink to &quot;缓存策略&quot;">​</a></h4><ul><li>缓存键：基于 Token 内容的 SHA256 哈希</li><li>缓存值：验证结果和过期时间</li><li>自动过期：缓存过期时间不超过 Token 本身有效期</li></ul><h4 id="性能提升-3" tabindex="-1">性能提升 <a class="header-anchor" href="#性能提升-3" aria-label="Permalink to &quot;性能提升&quot;">​</a></h4><ul><li>减少 Token 验证计算开销</li><li>降低 CPU 使用率</li><li>提高 API 响应速度</li></ul><hr><h2 id="注释规范" tabindex="-1">注释规范 <a class="header-anchor" href="#注释规范" aria-label="Permalink to &quot;注释规范&quot;">​</a></h2><h3 id="开发规范要求" tabindex="-1">开发规范要求 <a class="header-anchor" href="#开发规范要求" aria-label="Permalink to &quot;开发规范要求&quot;">​</a></h3><p>所有代码注释严格按照开发规范：</p><ol><li><p><strong>使用简洁的中文注释</strong></p><ul><li>避免使用括号进行解释</li><li>直接说明代码功能</li></ul></li><li><p><strong>注释位置</strong></p><ul><li>注释放在代码上方</li><li>与代码对齐</li></ul></li><li><p><strong>注释内容</strong></p><ul><li>说明代码作用，不解释实现细节</li><li>避免冗余信息</li></ul></li></ol><h4 id="正确示例" tabindex="-1">正确示例 <a class="header-anchor" href="#正确示例" aria-label="Permalink to &quot;正确示例&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取用户ID从会话或Cookie</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_Http_Request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 验证IP地址格式，无效IP设为默认值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ip </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_Common</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetClientIp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;0.0.0.0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h4 id="错误示例" tabindex="-1">错误示例 <a class="header-anchor" href="#错误示例" aria-label="Permalink to &quot;错误示例&quot;">​</a></h4><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：获取用户ID（从会话或Cookie）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：验证IP地址格式（无效IP设为默认值）</span></span></code></pre></div><hr><h2 id="性能指标" tabindex="-1">性能指标 <a class="header-anchor" href="#性能指标" aria-label="Permalink to &quot;性能指标&quot;">​</a></h2><h3 id="优化前" tabindex="-1">优化前 <a class="header-anchor" href="#优化前" aria-label="Permalink to &quot;优化前&quot;">​</a></h3><ul><li>数据库连接：每次请求创建新连接</li><li>CSRF Token：存储在 Session，存在锁竞争</li><li>钩子执行：每次解析回调函数</li><li>配置读取：每次解析配置路径</li><li>Token 验证：每次完整验证计算</li></ul><h3 id="优化后" tabindex="-1">优化后 <a class="header-anchor" href="#优化后" aria-label="Permalink to &quot;优化后&quot;">​</a></h3><ul><li>数据库连接：单例模式，请求内复用</li><li>CSRF Token：无状态设计，无锁竞争</li><li>钩子执行：回调缓存，减少解析</li><li>配置读取：内存缓存，直接读取</li><li>Token 验证：结果缓存，减少计算</li></ul><h3 id="预期提升" tabindex="-1">预期提升 <a class="header-anchor" href="#预期提升" aria-label="Permalink to &quot;预期提升&quot;">​</a></h3><ul><li><strong>响应时间</strong>：减少 20-30%</li><li><strong>内存占用</strong>：降低 15-25%</li><li><strong>CPU 使用率</strong>：降低 10-20%</li><li><strong>并发能力</strong>：提升 30-50%</li></ul><hr><h2 id="最佳实践" tabindex="-1">最佳实践 <a class="header-anchor" href="#最佳实践" aria-label="Permalink to &quot;最佳实践&quot;">​</a></h2><h3 id="数据库操作" tabindex="-1">数据库操作 <a class="header-anchor" href="#数据库操作" aria-label="Permalink to &quot;数据库操作&quot;">​</a></h3><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 推荐：使用单例模式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$db </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_Database</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($userId);</span></span></code></pre></div><h3 id="csrf-token" tabindex="-1">CSRF Token <a class="header-anchor" href="#csrf-token" aria-label="Permalink to &quot;CSRF Token&quot;">​</a></h3><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 推荐：使用无状态 Token（默认启用）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$token </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_Auth_Csrf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">generateToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_Auth_Csrf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($token);</span></span></code></pre></div><h3 id="钩子注册" tabindex="-1">钩子注册 <a class="header-anchor" href="#钩子注册" aria-label="Permalink to &quot;钩子注册&quot;">​</a></h3><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 推荐：使用命名函数或类方法</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_System_Hook</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my_action&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my_function&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Anon_System_Hook</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my_filter&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MyClass</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;method&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span></code></pre></div><h3 id="配置读取" tabindex="-1">配置读取 <a class="header-anchor" href="#配置读取" aria-label="Permalink to &quot;配置读取&quot;">​</a></h3><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 配置会自动缓存，无需特殊处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$enabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_System_Env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;app.token.enabled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="token-验证" tabindex="-1">Token 验证 <a class="header-anchor" href="#token-验证" aria-label="Permalink to &quot;Token 验证&quot;">​</a></h3><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Token 验证结果会自动缓存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$payload </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Anon_Auth_Token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($token);</span></span></code></pre></div><hr><h2 id="注意事项" tabindex="-1">注意事项 <a class="header-anchor" href="#注意事项" aria-label="Permalink to &quot;注意事项&quot;">​</a></h2><h3 id="数据库单例" tabindex="-1">数据库单例 <a class="header-anchor" href="#数据库单例" aria-label="Permalink to &quot;数据库单例&quot;">​</a></h3><ul><li>单例模式确保请求内连接复用</li><li>不同请求之间连接会自动管理</li><li>无需手动关闭连接</li></ul><h3 id="csrf-token-1" tabindex="-1">CSRF Token <a class="header-anchor" href="#csrf-token-1" aria-label="Permalink to &quot;CSRF Token&quot;">​</a></h3><ul><li>无状态 Token 默认启用</li><li>可通过配置切换为传统模式</li><li>Token 有效期 2 小时</li></ul><h3 id="钩子缓存" tabindex="-1">钩子缓存 <a class="header-anchor" href="#钩子缓存" aria-label="Permalink to &quot;钩子缓存&quot;">​</a></h3><ul><li>回调缓存自动管理</li><li>过滤器结果缓存可手动清除</li><li>建议避免使用闭包</li></ul><h3 id="配置缓存-1" tabindex="-1">配置缓存 <a class="header-anchor" href="#配置缓存-1" aria-label="Permalink to &quot;配置缓存&quot;">​</a></h3><ul><li>配置缓存自动管理</li><li>配置更新后需清除缓存</li><li>开发环境建议禁用缓存</li></ul><h3 id="token-验证缓存-1" tabindex="-1">Token 验证缓存 <a class="header-anchor" href="#token-验证缓存-1" aria-label="Permalink to &quot;Token 验证缓存&quot;">​</a></h3><ul><li>验证结果缓存自动管理</li><li>缓存过期时间自动计算</li><li>无需手动清除缓存</li></ul><hr><h2 id="故障排查" tabindex="-1">故障排查 <a class="header-anchor" href="#故障排查" aria-label="Permalink to &quot;故障排查&quot;">​</a></h2><h3 id="数据库连接问题" tabindex="-1">数据库连接问题 <a class="header-anchor" href="#数据库连接问题" aria-label="Permalink to &quot;数据库连接问题&quot;">​</a></h3><p>如果遇到数据库连接问题，检查：</p><ol><li>是否正确使用 <code>getInstance()</code> 方法</li><li>数据库配置是否正确</li><li>连接池是否正常工作</li></ol><h3 id="csrf-token-问题" tabindex="-1">CSRF Token 问题 <a class="header-anchor" href="#csrf-token-问题" aria-label="Permalink to &quot;CSRF Token 问题&quot;">​</a></h3><p>如果遇到 CSRF Token 验证失败：</p><ol><li>检查是否启用无状态模式</li><li>验证 Token 是否过期</li><li>检查 Session ID 是否匹配</li></ol><h3 id="钩子执行问题" tabindex="-1">钩子执行问题 <a class="header-anchor" href="#钩子执行问题" aria-label="Permalink to &quot;钩子执行问题&quot;">​</a></h3><p>如果钩子未执行：</p><ol><li>检查回调函数是否正确注册</li><li>验证回调函数是否可调用</li><li>查看调试日志获取详细信息</li></ol><h3 id="配置读取问题" tabindex="-1">配置读取问题 <a class="header-anchor" href="#配置读取问题" aria-label="Permalink to &quot;配置读取问题&quot;">​</a></h3><p>如果配置读取异常：</p><ol><li>清除配置缓存：<code>Anon_System_Env::clearCache()</code></li><li>检查配置键是否正确</li><li>验证配置文件格式</li></ol><h3 id="token-验证问题" tabindex="-1">Token 验证问题 <a class="header-anchor" href="#token-验证问题" aria-label="Permalink to &quot;Token 验证问题&quot;">​</a></h3><p>如果 Token 验证失败：</p><ol><li>检查 Token 是否过期</li><li>验证 Token 签名是否正确</li><li>查看调试日志获取详细信息</li></ol>`,114)])])}const g=s(h,[["render",e]]);export{c as __pageData,g as default};
